processor:
  name: usdc-filter
  type: transform
  description: Filter token transfer events for USDC only
  version: 1.0.0
  language: Go
  license: MIT
  maintainers:
    - withObsrvr

repo:
  github: withObsrvr/nebu-processor-registry
  ref: main

docs:
  quick_start: |
    # Install the processor
    nebu install usdc-filter

    # Use in pipeline
    token-transfer --start-ledger 60200000 --end-ledger 60200100 | usdc-filter

  examples: |
    # Filter for USDC transfers only
    token-transfer --start-ledger 60200000 --end-ledger 60200100 | \
      usdc-filter | \
      json-file-sink --out usdc-transfers.jsonl

    # Pipe to DuckDB for analytics
    token-transfer --start-ledger 60200000 --end-ledger 60200100 | \
      usdc-filter | \
      duckdb -c "SELECT COUNT(*) FROM read_json('/dev/stdin')"

    # Quiet mode
    token-transfer -q --start-ledger 60200000 | \
      usdc-filter -q | \
      nats-sink --subject "usdc.transfers"

    # Combine with amount filter for large USDC transfers
    token-transfer --start-ledger 60200000 --end-ledger 60200100 | \
      usdc-filter | \
      amount-filter --min 100000000 | \
      json-file-sink --out large-usdc.jsonl

  extended_description: |
    # USDC Filter Transform Processor

    A simple transform processor that filters token transfer events to only pass
    through USDC (USD Coin) transfers. Part of a composable Unix-style pipeline.

    ---

    ## Input Requirements

    This processor expects token-transfer events from stdin. It filters events
    based on the asset code in the following event types:

    | Event Type | Field Checked |
    |------------|---------------|
    | Transfer | `transfer.asset.code == "USDC"` |
    | Mint | `mint.asset.code == "USDC"` |
    | Burn | `burn.asset.code == "USDC"` |
    | Clawback | `clawback.asset.code == "USDC"` |

    **Note:** Fee events are filtered out (they are XLM-only).

    ---

    ## USDC Issuers

    The filter matches USDC from the following issuers:

    | Network | Issuer Address | Provider |
    |---------|----------------|----------|
    | Mainnet | `GA5ZSEJYB37JRC5AVCIA5MOP4RHTM335X2KGX3IHOJAPP5RE34K4KZVN` | Centre (Circle) |
    | Testnet | `GBBD47IF6LWK7P7MDEVSCWR7DPUWV3NY3DTQEVFL4NAT4AQH3ZLLFLA5` | Test issuer |

    The filter matches by asset code only (`USDC`), not by issuer. This means
    any asset with code "USDC" will pass through, regardless of issuer.

    ---

    ## Output Format

    Events are passed through unchanged. No fields are added, modified, or removed.
    Only events matching USDC criteria are emitted to stdout.

    **Input → Output Example:**

    ```
    Input:  {"transfer": {"asset": {"code": "USDC", ...}}, ...}  → Passed through
    Input:  {"transfer": {"asset": {"code": "XLM", ...}}, ...}   → Filtered out
    Input:  {"transfer": {"asset": {"code": "AQUA", ...}}, ...}  → Filtered out
    Input:  {"mint": {"asset": {"code": "USDC", ...}}, ...}      → Passed through
    Input:  {"fee": {"amount": "100"}, ...}                      → Filtered out
    ```

    ---

    ## Configuration

    | Flag | Description | Default |
    |------|-------------|---------|
    | `-q, --quiet` | Suppress startup banner | false |

    ---

    ## Pipeline Position

    ```
    ┌─────────────────┐     ┌─────────────┐     ┌──────────────┐
    │ token-transfer  │ ──▶ │ usdc-filter │ ──▶ │ json-file-   │
    │ (origin)        │     │ (transform) │     │ sink         │
    └─────────────────┘     └─────────────┘     └──────────────┘
           ▲                       │
           │                       │
    All token events         Only USDC events
    ```

    ---

    ## Performance

    | Metric | Value | Notes |
    |--------|-------|-------|
    | Throughput | ~100,000 events/sec | Simple string comparison |
    | Memory | < 10 MB | Stateless filter |
    | Latency | < 1 ms | No buffering |

    ---

    ## Use Cases

    - **Track USDC transfers specifically** — Focus on stablecoin activity
    - **Reduce data volume** — Filter before expensive downstream processing
    - **Build USDC analytics** — Volume, unique accounts, patterns
    - **Compliance monitoring** — Track stablecoin movements
    - **Payment tracking** — Monitor USDC-based payment flows

    ---

    ## Common Pipelines

    **1. USDC transfer history:**
    ```bash
    token-transfer --start-ledger 60200000 --end-ledger 60300000 | \
      usdc-filter | \
      json-file-sink --out usdc-history.jsonl
    ```

    **2. Large USDC transfers (whale tracking):**
    ```bash
    token-transfer --start-ledger 60200000 --follow | \
      usdc-filter | \
      amount-filter --min 100000000 | \
      nats-sink --subject "alerts.usdc.whales"
    ```

    **3. USDC to PostgreSQL:**
    ```bash
    token-transfer --start-ledger 60200000 --follow | \
      usdc-filter | \
      postgres-sink --dsn "$POSTGRES_DSN" --table usdc_transfers
    ```

    **4. Deduplicated USDC stream:**
    ```bash
    token-transfer --start-ledger 60200000 --follow | \
      usdc-filter | \
      dedup --key meta.txHash | \
      json-file-sink --out usdc-unique.jsonl
    ```

    ---

    ## Comparison with jq Filtering

    This processor is equivalent to:
    ```bash
    token-transfer ... | jq -c 'select(
      (.transfer.asset.code == "USDC") or
      (.mint.asset.code == "USDC") or
      (.burn.asset.code == "USDC") or
      (.clawback.asset.code == "USDC")
    )'
    ```

    **Why use usdc-filter instead of jq?**
    - Faster (compiled Go vs interpreted jq)
    - Less memory usage
    - Simpler pipeline syntax
    - Consistent with other nebu processors

    ---

    ## Limitations

    - Filters by asset code only, not by issuer
    - Does not validate USDC issuer authenticity
    - Fee events are always filtered out
    - Cannot filter for multiple assets (use jq for complex filters)

    ---

    ## Best Practices

    1. **Pipeline Usage:** Use quiet mode (`-q`) when piping to other processors
    2. **Early Filtering:** Place early in pipeline to reduce downstream data volume
    3. **Combine Filters:** Chain with amount-filter for threshold-based alerts
    4. **Production:** Use with postgres-sink for queryable USDC history
