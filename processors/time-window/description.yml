processor:
  name: time-window
  type: transform
  description: Filter events by time range using ledger timestamps
  version: 1.0.0
  language: Go
  license: MIT
  maintainers:
    - withObsrvr

repo:
  github: withObsrvr/nebu
  ref: main

docs:
  quick_start: |
    # Install the processor
    nebu install time-window

    # Events from last hour
    token-transfer --start-ledger 60200000 | time-window --last 1h

    # Events from last 24 hours
    token-transfer --start-ledger 60200000 | time-window --last 24h

  examples: |
    # Track recent whale movements (last 6 hours)
    token-transfer --start-ledger 60200000 --follow | \
      amount-filter --min 10000000000 | \
      time-window --last 6h | \
      nats-sink --subject "whales.recent"

    # Weekly reports
    token-transfer --start-ledger 60000000 --end-ledger 60300000 | \
      usdc-filter | \
      time-window --last 168h | \
      json-file-sink --out weekly-usdc.jsonl

    # Custom time range (Unix timestamps)
    contract-events --start-ledger 60200000 --end-ledger 60300000 | \
      time-window --start 1704067200 --end 1704153600 | \
      postgres-sink --table jan_2024_events

    # Recent contract activity (last 30 minutes)
    contract-invocation --start-ledger 60200000 --follow | \
      time-window --last 30m | \
      jq 'select(.functionName == "swap")'

  extended_description: |
    # Time Window Transform Processor

    Filters events based on time ranges using ledger timestamps. Supports
    relative time windows (`--last 1h`) and absolute Unix timestamp ranges.

    ---

    ## Ledger-to-Time Conversion

    Stellar ledgers close approximately every 5 seconds. This processor uses
    the `meta.timestamp` field (ISO 8601) or estimates time from ledger sequence.

    | Duration  | Approximate Ledgers | Calculation   |
    |-----------|---------------------|---------------|
    | 1 minute  | ~12 ledgers         | 60s ÷ 5s      |
    | 5 minutes | ~60 ledgers         | 300s ÷ 5s     |
    | 1 hour    | ~720 ledgers        | 3600s ÷ 5s    |
    | 6 hours   | ~4,320 ledgers      | 21600s ÷ 5s   |
    | 24 hours  | ~17,280 ledgers     | 86400s ÷ 5s   |
    | 7 days    | ~120,960 ledgers    | 604800s ÷ 5s  |
    | 30 days   | ~518,400 ledgers    | 2592000s ÷ 5s |

    ---

    ## Time Accuracy

    | Aspect | Value |
    |--------|-------|
    | Precision | ±5 seconds (one ledger interval) |
    | Source | `meta.timestamp` field (ISO 8601) |
    | Fallback | Ledger sequence × 5 seconds from genesis |
    | Genesis | July 1, 2015 00:00:00 UTC (Stellar mainnet) |

    **Note:** Actual ledger close times vary slightly (4-6 seconds), so time
    estimates have ±5 second accuracy. For most analytics, this is sufficient.

    ---

    ## Duration Syntax

    The `--last` flag accepts Go duration format:

    | Format | Duration | Example |
    |--------|----------|---------|
    | `Xm` | X minutes | `30m`, `90m` |
    | `Xh` | X hours | `1h`, `6h`, `24h` |
    | `Xh` | X days as hours (Go has no day unit) | `168h` (7 days), `720h` (30 days) |

    **Examples:**
    - `--last 30m` — Last 30 minutes
    - `--last 6h` — Last 6 hours
    - `--last 24h` — Last 24 hours
    - `--last 168h` — Last 7 days

    ---

    ## Configuration

    | Flag | Description | Default |
    |------|-------------|---------|
    | `--last` | Relative time window (e.g., `1h`, `24h`) | — |
    | `--start` | Start time as Unix timestamp (seconds) | 0 (no limit) |
    | `--end` | End time as Unix timestamp (seconds) | 0 (no limit) |
    | `-q, --quiet` | Suppress startup banner | false |

    **Mode Selection:**
    - Use `--last` for relative windows (most common)
    - Use `--start` and `--end` for absolute ranges
    - Cannot combine `--last` with `--start`/`--end`

    ---

    ## Filter Behavior

    | Configuration | Behavior |
    |---------------|----------|
    | `--last 1h` | Events from (now - 1 hour) to now |
    | `--start X` | Events from Unix timestamp X onwards |
    | `--end X` | Events up to Unix timestamp X |
    | `--start X --end Y` | Events between X and Y (inclusive) |

    ---

    ## Performance

    | Metric | Value | Notes |
    |--------|-------|-------|
    | Throughput | ~100,000 events/sec | Simple timestamp comparison |
    | Memory | < 10 MB | Stateless filter |
    | Latency | < 1 ms | No buffering |

    ---

    ## Use Cases

    - **Recent events only** — Filter large backfill to recent data
    - **Time-based reports** — Daily, weekly, monthly summaries
    - **Real-time monitoring** — Sliding window alerts
    - **Historical analysis** — Specific date ranges
    - **Data retention** — Only process last N hours

    ---

    ## Common Pipelines

    **1. Real-time monitoring (last 5 minutes):**
    ```bash
    token-transfer --start-ledger 60200000 --follow | \
      time-window --last 5m | \
      amount-filter --min 10000000000 | \
      nats-sink --subject "alerts.large-transfers"
    ```

    **2. Daily USDC report:**
    ```bash
    token-transfer --start-ledger 60000000 --end-ledger 60300000 | \
      usdc-filter | \
      time-window --last 24h | \
      json-file-sink --out daily-usdc.jsonl
    ```

    **3. Specific date range (Jan 1-7, 2024):**
    ```bash
    # Convert dates to Unix timestamps
    # Jan 1, 2024 00:00:00 UTC = 1704067200
    # Jan 7, 2024 23:59:59 UTC = 1704671999
    contract-events --start-ledger 60200000 --end-ledger 60500000 | \
      time-window --start 1704067200 --end 1704671999 | \
      postgres-sink --table jan_week1_events
    ```

    **4. Sliding window aggregation:**
    ```bash
    # Count events per hour (run hourly via cron)
    token-transfer --start-ledger 60200000 --end-ledger 60300000 | \
      time-window --last 1h | \
      wc -l >> hourly-counts.log
    ```

    ---

    ## Unix Timestamp Reference

    | Date | Unix Timestamp |
    |------|----------------|
    | Jan 1, 2024 00:00 UTC | 1704067200 |
    | Jul 1, 2024 00:00 UTC | 1719792000 |
    | Jan 1, 2025 00:00 UTC | 1735689600 |
    | Current time | `date +%s` |

    **Convert date to timestamp:**
    ```bash
    date -d "2024-01-15 00:00:00 UTC" +%s
    # Output: 1705276800
    ```

    **Convert timestamp to date:**
    ```bash
    date -d @1704067200
    # Output: Mon Jan  1 00:00:00 UTC 2024
    ```

    ---

    ## Comparison with Ledger Range Filtering

    | Approach | Use Case |
    |----------|----------|
    | `--start-ledger`, `--end-ledger` | Exact ledger boundaries |
    | `time-window --last` | Human-readable time windows |
    | `time-window --start --end` | Exact Unix timestamp ranges |

    **When to use time-window:**
    - You think in hours/days, not ledger numbers
    - You want recent data from a large backfill
    - You need exact calendar date boundaries

    ---

    ## Limitations

    - Requires `meta.timestamp` or `meta.ledgerSequence` field
    - Time estimates have ±5 second accuracy
    - Cannot handle timezone-specific ranges (uses UTC)
    - `--last` is relative to current time at startup

    ---

    ## Best Practices

    1. **Use --last for relative windows:** Simpler and more readable
    2. **UTC timestamps:** Always use UTC for --start/--end
    3. **Combine with --follow:** For real-time sliding windows
    4. **Place early in pipeline:** Filter before expensive processing
    5. **Document timestamps:** Comment Unix timestamps in scripts
